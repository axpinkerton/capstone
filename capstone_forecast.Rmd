---
title: "capstone"
author: "Alex"
date: "7/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(forecast)
library(stringr)
library(lubridate)
library(e1071)
library(zoo)
library(data.table)
zri = read_csv('/Users/APinkerton/NYC_DS_A/projects/capstone/Zip_Zri_AllHomesPlusMultifamily.csv')
zori = read_csv('/Users/APinkerton/NYC_DS_A/projects/capstone/Zip_ZORI_AllHomesPlusMultifamily_SSA.csv')

zori_longer <- zori %>% pivot_longer(cols=starts_with('20'),names_to = 'month_yr',values_to = 'rent',values_drop_na = F)

zori_longer$year = substr(zori_longer$month_yr,1,4)
zori_longer$month = substr(zori_longer$month_yr,6,7)
zl1 <- zori_longer[zori_longer$year > 2014,] 
sub_zl <- zl1[zl1$year<2021,]
sub_zori <- sub_zl %>% drop_na(rent)

zori_full <- sub_zori %>% group_by(month_yr)%>%summarise(mean_rent=as.numeric(mean(rent)))
zori_full$mo = substr(zori_full$month_yr,6,7)
zori_full$yr = substr(zori_full$month_yr,1,4)
#zori_full = subset(zori_full,select=c(-month_yr))
to_diff <- zori_full %>% pivot_wider(names_from = mo, values_from = mean_rent)
to_diff$yr=as.numeric(to_diff$yr)


p <- ggplot(data=zori_full, aes(x=as.Date(as.yearmon(month_yr)), y=mean_rent)) +
  geom_line() + 
  xlab("")
p
p+scale_x_date(date_labels = "%Y-%m-%d")
zori_full
zori_full$month_yr = as.Date(as.yearmon(zori_full$month_yr))
zori_full = subset(zori_full,select=c(-mo,-yr))
zori_full$mean_rent

plot.ts(diff(zori_full$mean_rent,12))

```

```{r}
d = 1
for (p in 1:2) {
  for (q in 1:2) {
    if (p + q + d <= 5) {
      model = arima(x=zori_full$mean_rent, order = c((p-1), d,(q-1)))
      pval = Box.test(model$residuals, lag = log(length(model$residuals)))
      sse = sum(model$residuals^2)
      cat(p-1,d,q-1, "AIC=", model$aic, " SSE =", sse, " p-VALUE=", pval$p.value, "\n")
    }
  }
}

AP.arima = arima(x=zori_full$mean_rent, order = c(1,1,1))

AP.predict = forecast(AP.arima, h=12, level=85)

autoplot(AP.predict)

```
```{r}
d = 1
DD = 1
per = 12
for(p in 1:2){
  for(q in 1:2){
    for(i in 1:2){
      for(j in 1:2){
        if(p+d+q+i+DD+j<=10){
          model<-arima(x=zori_full$mean_rent, order = c((p-1),d,(q-1)), seasonal = list(order=c((i-1),DD,(j-1)), period=per))
          pval<-Box.test(model$residuals, lag=log(length(model$residuals)))
          sse<-sum(model$residuals^2)
          cat(p-1,d,q-1,i-1,DD,j-1,per, 'AIC=', model$aic, ' SSE=',sse,' p-VALUE=', pval$p.value,'\n')
        }
      }
    }
  }
}

AP.sarima = arima(x=zori_full$mean_rent, order = c(0,1,0), seasonal = list(order = c(0,1,0), period = per))

AP.predict = forecast(AP.sarima, h=60, level = 80)

autoplot(AP.predict)

```
